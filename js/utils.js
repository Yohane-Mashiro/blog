import{initMasonry}from"./plugins/masonry.js";import{navbarShrink}from"./layouts/navbarShrink.js";export function initUtils(){Global.utils={html_root_dom:document.querySelector("html"),pageContainer_dom:document.querySelector(".page-container"),pageTop_dom:document.querySelector(".main-content-header"),homeBanner_dom:document.querySelector(".home-banner-container"),scrollProgressBar_dom:document.querySelector(".scroll-progress-bar"),pjaxProgressBar_dom:document.querySelector(".pjax-progress-bar"),pjaxProgressIcon_dom:document.querySelector(".swup-progress-icon"),backToTopButton_dom:document.querySelector(".tool-scroll-to-top"),toolsList:document.querySelector(".hidden-tools-list"),toggleButton:document.querySelector(".toggle-tools-list"),innerHeight:window.innerHeight,pjaxProgressBarTimer:null,prevScrollValue:0,fontSizeLevel:0,isHasScrollProgressBar:Global.theme_config.global.scroll_progress.bar===true,isHasScrollPercent:Global.theme_config.global.scroll_progress.percentage===true,updateScrollStyle(){const e=window.pageYOffset||document.documentElement.scrollTop;const t=document.documentElement.scrollHeight;const o=window.innerHeight||document.documentElement.clientHeight;const n=this.calculatePercentage(e,t,o);this.updateScrollProgressBar(n);this.updateScrollPercent(n);this.updatePageTopVisibility(e,o);this.prevScrollValue=e},updateScrollProgressBar(e){if(this.isHasScrollProgressBar){const t=e.toFixed(3);const o=e===0?"hidden":"visible";this.scrollProgressBar_dom.style.visibility=o;this.scrollProgressBar_dom.style.width=`${t}%`}},updateScrollPercent(e){if(this.isHasScrollPercent){const t=this.backToTopButton_dom.querySelector(".percent");const o=e!==0&&e!==undefined;this.backToTopButton_dom.classList.toggle("show",o);t.innerHTML=e.toFixed(0)}},updatePageTopVisibility(e,t){if(Global.theme_config.navbar.auto_hide){const o=this.prevScrollValue;const n=o>t&&e>o;this.pageTop_dom.classList.toggle("hide",n)}else{this.pageTop_dom.classList.remove("hide")}},calculatePercentage(e,t,o){return Math.round(e/(t-o)*100)},registerWindowScroll(){window.addEventListener("scroll",(()=>{this.updateScrollStyle();this.updateTOCScroll();this.updateNavbarShrink();this.updateHomeBannerBlur();this.updateAutoHideTools();this.updateAPlayerAutoHide()}))},updateTOCScroll(){if(Global.theme_config.articles.toc.enable&&Global.utils.hasOwnProperty("updateActiveTOCLink")){Global.utils.updateActiveTOCLink()}},updateNavbarShrink(){navbarShrink.init()},updateHomeBannerBlur(){if(Global.theme_config.home_banner.style==="fixed"&&location.pathname===Global.hexo_config.root){const e=document.querySelector(".home-banner-background");const t=window.innerHeight;const o=window.scrollY||window.pageYOffset;const n=t/2;const s=o>=n?15:0;try{e.style.transition="0.3s";e.style.webkitFilter=`blur(${s}px)`}catch(e){}}},updateAutoHideTools(){const e=window.pageYOffset;const t=document.body.scrollHeight;const o=window.innerHeight;const n=document.getElementsByClassName("right-side-tools-container");for(let s=0;s<n.length;s++){const l=n[s];if(e<=0){if(location.pathname!=="/"){}else{l.classList.add("hide")}}else if(e+o>=t-20){l.classList.add("hide")}else{l.classList.remove("hide")}}},updateAPlayerAutoHide(){const e=document.getElementById("aplayer");if(e==null){}else{const t=window.pageYOffset;const o=document.body.scrollHeight;const n=window.innerHeight;if(t<=0){if(location.pathname!=="/"){}else{e.classList.add("hide")}}else if(t+n>=o-20){e.classList.add("hide")}else{e.classList.remove("hide")}}},toggleToolsList(){this.toggleButton.addEventListener("click",(()=>{this.toolsList.classList.toggle("show")}))},globalFontSizeAdjust(){const e=this.html_root_dom;const t=document.querySelector(".tool-font-adjust-plus");const o=document.querySelector(".tool-font-adjust-minus");const n=document.defaultView.getComputedStyle(document.body).fontSize;const s=parseFloat(n);let l=0;const i=Global.getStyleStatus();if(i){l=i.fontSizeLevel;a(l)}function a(t){const o=s*(1+t*.05);e.style.fontSize=`${o}px`;Global.styleStatus.fontSizeLevel=t;Global.setStyleStatus()}function r(){l=Math.min(l+1,5);a(l)}function c(){l=Math.max(l-1,0);a(l)}t.addEventListener("click",r);o.addEventListener("click",c)},contentAreaWidthAdjust(){const e=document.querySelector(".tool-expand-width");const t=document.querySelector(".navbar-content");const o=document.querySelector(".main-content");const n=e.querySelector("i");const s=Global.theme_config.global.content_max_width||"1000px";const l="90%";let i=s;let a=false;if(Global.theme_config.home_banner.enable===true&&window.location.pathname==="/"){i=parseInt(s)*1.2+"px"}const r=e=>{Global.styleStatus.isExpandPageWidth=e;Global.setStyleStatus();if(e){n.classList.remove("fa-expand");n.classList.add("fa-compress");t.style.maxWidth=l;o.style.maxWidth=l}else{n.classList.remove("fa-compress");n.classList.add("fa-expand");t.style.maxWidth=i;o.style.maxWidth=s}};const c=()=>{const e=Global.getStyleStatus();if(e){a=e.isExpandPageWidth;r(a)}};c();e.addEventListener("click",(()=>{a=!a;r(a);var e=document.querySelector(".loading-placeholder");var t=document.querySelector("#masonry-container");if(!e||!t)return;e.style.opacity=1;e.style.display="block";t.style.display="none";setTimeout((()=>{initMasonry()}),300)}))},goComment(){this.goComment_dom=document.querySelector(".go-comment");if(this.goComment_dom){this.goComment_dom.addEventListener("click",(()=>{const e=document.querySelector("#comment-anchor");if(e){const t=e.getBoundingClientRect().top+window.scrollY;window.scrollTo({top:t,behavior:"smooth"})}}))}},getElementHeight(e){const t=document.querySelector(e);return t?t.getBoundingClientRect().height:0},inithomeBannerHeight(){this.homeBanner_dom&&(this.homeBanner_dom.style.height=this.innerHeight+"px")},initPageHeightHandle(){if(this.homeBanner_dom)return;const e=this.getElementHeight(".main-content-header");const t=this.getElementHeight(".main-content-body");const o=this.getElementHeight(".main-content-footer");const n=e+t+o;const s=window.innerHeight;const l=document.querySelector(".main-content-footer");if(n<s){const e=Math.floor(s-n);if(e>0){l.style.marginTop=`${e-2}px`}}},imageViewer(){let e=false;let t=1;let o=false;let n=0;let s=0;let l=0;let i=0;const a=document.querySelector(".image-viewer-container");const r=a.querySelector("img");const c=e=>{document.body.style.overflow=e?"hidden":"auto";e?a.classList.add("active"):a.classList.remove("active")};const d=e=>{e.preventDefault();const o=r.getBoundingClientRect();const n=e.clientX-o.left;const s=e.clientY-o.top;const a=n-o.width/2;const c=s-o.height/2;const d=t;t+=e.deltaY*-.001;t=Math.min(Math.max(.8,t),4);if(d<t){l-=a*(t-d);i-=c*(t-d)}else{l=0;i=0}r.style.transform=`translate(${l}px, ${i}px) scale(${t})`};const u=e=>{e.preventDefault();o=true;n=e.clientX;s=e.clientY};let m=0;const g=100;const h=e=>{if(o){const o=(new Date).getTime();if(o-m<g){return}m=o;const a=e.clientX-n;const c=e.clientY-s;l+=a;i+=c;n=e.clientX;s=e.clientY;r.style.transform=`translate(${l}px, ${i}px) scale(${t})`}};const f=e=>{if(o){e.stopPropagation()}o=false};r.addEventListener("wheel",d);r.addEventListener("mousedown",u);r.addEventListener("mousemove",h);r.addEventListener("mouseup",f);r.addEventListener("mouseleave",f);a.addEventListener("click",(o=>{if(o.target!==o.currentTarget){return}e=false;c(e);t=1;l=0;i=0;r.style.transform=`translate(${l}px, ${i}px) scale(${t})`}));const p=document.querySelectorAll(".markdown-body img, .masonry-item img, #shuoshuo-content img");const y=o=>{if(o.key==="Escape"&&e){e=false;c(e);t=1;l=0;i=0;r.style.transform=`translate(${l}px, ${i}px) scale(${t})`;document.removeEventListener("keydown",y)}};p.forEach((t=>{t.addEventListener("click",(()=>{e=true;c(e);r.src=t.src;document.addEventListener("keydown",y)}))}));if(!p.length&&a){a.parentNode.removeChild(a)}},setHowLongAgoLanguage(e,t){return t.replace(/%s/g,e)},getHowLongAgo(e){const t=Global.language_ago;const o=Math.floor(e/(60*60*24*30)/12);const n=Math.floor(e/(60*60*24*30));const s=Math.floor(e/(60*60*24)/7);const l=Math.floor(e/(60*60*24));const i=Math.floor(e/(60*60)%24);const a=Math.floor(e/60%60);const r=Math.floor(e%60);if(o>0){return this.setHowLongAgoLanguage(o,t.year)}else if(n>0){return this.setHowLongAgoLanguage(n,t.month)}else if(s>0){return this.setHowLongAgoLanguage(s,t.week)}else if(l>0){return this.setHowLongAgoLanguage(l,t.day)}else if(i>0){return this.setHowLongAgoLanguage(i,t.hour)}else if(a>0){return this.setHowLongAgoLanguage(a,t.minute)}else if(r>0){return this.setHowLongAgoLanguage(r,t.second)}},relativeTimeInHome(){const e=document.querySelectorAll(".home-article-meta-info .home-article-date");const t=Global.theme_config.home.article_date_format;if(t==="relative"){e&&e.forEach((e=>{const t=Date.now();const o=new Date(e.dataset.date.split(" GMT")[0]).getTime();e.innerHTML=this.getHowLongAgo(Math.floor((t-o)/1e3))}))}else if(t==="auto"){e&&e.forEach((e=>{const t=Date.now();const o=new Date(e.dataset.date.split(" GMT")[0]).getTime();const n=Math.floor((t-o)/(60*60*24*1e3));if(n<7){e.innerHTML=this.getHowLongAgo(Math.floor((t-o)/1e3))}}))}}};Global.utils.registerWindowScroll();Global.utils.toggleToolsList();Global.utils.globalFontSizeAdjust();Global.utils.contentAreaWidthAdjust();Global.utils.goComment();Global.utils.initPageHeightHandle();Global.utils.inithomeBannerHeight();Global.utils.imageViewer();Global.utils.relativeTimeInHome()}